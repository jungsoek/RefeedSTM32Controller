# 7. 센서·전자·제어 시스템 설계

## 7.1 메인 MCU 선택(ESP32? STM32? 산업용 PLC?)

- **선정 기준 정의**
  - 컨베이어 제어(양측 독립 속도 제어, 모터 드라이브 제어)
  - 펌프 제어(PWM/릴레이/정압 유지 제어)
  - 다수의 센서 확보(레벨, 온도, 압력, 토크, 비상정지, 경사 센서 등)
  - 실내/야외 혼합 환경에서 안정성 확보
  - 장시간 운용 시 발열·간섭 최소화
  - 이동식 장비 특성상 **전력 효율/충전 관리** 기능 필요
  - 통신 요구사항(Wi-Fi? BLE? RS485? CAN? 이더넷?)에 따른 인터페이스 고려

------

#### **① ESP32 계열(ESP32, ESP32-S3, ESP32-C3)**

- **장점**
  - Wi-Fi/BLE 통신 내장 → 원격 모니터링, OTA 업데이트 용이
  - 비용 저렴, 개발 난이도 낮음
  - 충분한 연산력(240MHz급), 멀티태스킹 가능
  - 다양한 PWM/GPIO 사용 가능
- **단점**
  - 산업환경에서 **EMI/노이즈 내성 부족**
  - 고온 환경(>60°C)에서 안정성 떨어질 수 있음
  - ADC 분해능, 노이즈 내성은 STM32 대비 약함
- **적합한 경우**
  - 실내 위주 운영
  - 통신/IoT 기능이 중요할 때
  - 비용을 최소화하고 기능을 빠르게 구현해야 할 때

------

#### **② STM32 계열(STM32F4/F7/L4/G4/H7 등)**

- **장점**
  - 산업용 수준의 안정성, 넓은 온도 범위(-40~85°C) 지원
  - 고분해능 ADC, 안정적인 PWM, 실시간 제어 능력 우수
  - CAN, RS485, I²C, SPI 등 센서 확장성 뛰어남
  - FreeRTOS 기반 고신뢰성 펌웨어 구성 가능
- **단점**
  - ESP32 대비 Wi-Fi/BLE 직접 제공 없음(추가 모듈 필요)
  - 개발 난이도 및 초기 설정이 높음
  - 단가 증가
- **적합한 경우**
  - 24시간 장시간 운전, 잦은 진동, 고온 환경 등 **산업적 신뢰성**이 중요할 때
  - 컨베이어/펌프 제어 정확도가 높아야 할 때
  - 다양한 센서와 통신 버스를 연결해야 할 때

------

#### **③ 산업용 PLC(LS, Siemens LOGO!, Mitsubishi FX, Micro PLC 등)**

- **장점**
  - 고신뢰성 · 방진 · 방수 · 내열 설계
  - 산업 표준 I/O 모듈 확장 쉬움
  - 유지보수 및 정비가 매우 편리
  - 펌프/모터/밸브가 많은 장비에 최적
- **단점**
  - 가격 매우 높음
  - 크기와 무게 증가 → *냉장고 크기 장비에는 부담될 수 있음*
  - OTA/무선 업데이트 불가능에 가까움
  - 세세한 UI/디스플레이 연동은 약함
- **적합한 경우**
  - 공장 자동화 라인과 연계해야 할 때
  - 극도로 높은 신뢰성 요구
  - 정식 인증(CE, KC, 산업기계 인증)을 받아야 하는 상업용 제품 개발 시

------

### **결론: 어떤 MCU가 이 장비에 최적?**

**냉장고 크기의 이동식 폐식용유 수거 로봇**이라는 조건에서 가장 적합한 선택은:

------

### **🏆 최적 조합: STM32 + ESP32 듀얼 MCU 구조**

- **STM32**: 메인 제어(컨베이어, 펌프, 센서 처리, 안전 로직)
- **ESP32**: 통신 전담(Wi-Fi/BLE, OTA, UI 앱 연동)

장점:

- 실시간 안정성 + IoT 기능을 동시에 확보
- 산업 장비 수준의 신뢰성 유지
- 무선 업데이트 및 데이터 전송도 가능
- PLC 대비 저비용, 소형화 용이

## 7.2 컨베이어 모터 드라이버

### **기본 요구사항 정의**

- 좌·우측 컨베이어 각각 독립 제어
- 정/역회전 지원
- 저속 고토크 구동(폐식용유 및 이물질을 끌어올리는 구조 특성)
- PWM 기반 속도제어 필요
- 과부하/막힘 상황에서 **토크 리미트 또는 전류 제한 기능 필수**
- 점도 높은 폐유 접촉으로 인해 **모터 stall 가능성 높음** → 보호 회로 요구됨
- IP54~IP65 수준의 방진·방수 요구
- MCU(주로 STM32)와의 인터페이스는 **PWM + 방향(DIR) + 피드백(CUR 센서)** 방식 추천

------

### **① 모터 종류에 따른 드라이버 선택**

#### **A. DC 기어드 모터(브러시드)**

- **장점**: 

  저속·고토크, 제어 단순, 드라이버 가격 저렴

- **필요 드라이버**:

  - BTS7960(43A)
  - VNH5019(30A)
  - IBT-2 기반 H브릿지

- **적합성**:

  - 소형 냉장고급 장비에서 가장 실용적
  - 유지보수 쉬움

- **단점**:

  - 브러시 마모 → 장기적 신뢰성은 BLDC보다 떨어짐

------

#### **B. 브러시리스 DC 모터(BLDC, 3상)**

- **장점**: 고효율·저발열·긴 수명
- **필요 드라이버**:
  - 3상 FOC 기반 드라이버 (STSPIN32, DRV8305, DRV8316 등)
- **적합성**:
  - 장시간 운전, 실외 환경
  - 고토크가 필요하지만 모터 크기를 줄이고 싶을 때
- **단점**:
  - 제어 복잡(FOC 구현 필요)
  - 가격 상승

------

#### **C. 스테퍼 모터(고정밀 속도 제어 가능)**

- **장점**: 일정한 속도 유지, 부하 변화에 대한 제어 쉬움
- **필요 드라이버**:
  - DM542, TB6600 등 고전류 스테퍼 드라이버
- **적합성**:
  - 정밀 동작이 필요한 특수 용도
- **단점**:
  - 효율 낮음, 발열 크고 토크 대비 크기 큼
  - 막힘 상황에서는 스텝로스 발생

→ **이 장비에는 스테퍼는 비효율적이므로 비추천.**

------

### **② 권장 모터 드라이버 구조: H브릿지 기반 DC 기어모터 + 전류 센싱**

- **왜 DC 기어드 모터 + H-브릿지가 최적인가?**
  - 저속에서도 높은 토크
  - 컨베이어 특성상 위치 제어가 필요하지 않음 → 속도제어만으로 충분
  - 모터 stall 대응(전류 제한)이 간단
  - 전체 시스템 비용 최소화
  - 방수 설계 및 유지보수가 쉬움

------

### **③ 구체적인 드라이버 추천**

#### **1) ST VNH5019 (30A 피크 / 12~24V)**

- 산업용 등급에 가까운 안정성
- 전류 센싱 내장 → stall 감지 쉬움
- 20~30kgf·cm 급 기어드 모터에 적합

#### **2) Infineon BTS7960 모듈 (43A)**

- 저렴·고전류
- 단, 방열판 요구
- 실외 환경에서는 방수 하우징 필수

#### **3) TI DRV8871/8873(10A 이하) – 소형 컨베이어용**

- 소형 냉장고급 장비에서 전력 소모 낮을 때
- 전류 제한 기능 우수

------

### **④ 보호 기능 설계(필수요구)**

- **과전류 차단(OCP)**: 모터 stall 또는 이물질 끼임 대비
- **과열 보호(OTP)**: 장시간 운전 대비
- **저전압 보호(UVLO)**: 배터리 보호
- **전류 피드백 기반 토크 리미트**
  - 목표 전류(I_limit) 설정
  - stall 감지 → 자동 역회전/재시도 알고리즘 가능

------

### **⑤ MCU와의 인터페이스 구조**

- PWM → 속도 제어
- DIR → 정/역 회전
- FB(Current sense) → 부하 감지
- Fault 핀 → 긴급 정지
- Enable → 모터 전원 차단

------

### **⑥ 향후 확장성(멀티 모터 포함)**

- 좌측·우측 컨베이어 외에
  - 스크레이퍼 구동
  - 이물질 제거 브러시
  - 보조 유입 푸셔
     추가 가능 → 드라이버 3~5개 확장 대비
- CAN 또는 RS485 기반의 **확장 모터 모듈** 구성 가능

## 7.3 주행 모터 드라이버

### **기본 요구 조건 정의**

- 소형 냉장고급 이동식 장비(약 40~80kg)
- 실내/실외 바닥(타일, 콘크리트, 스틸그레이트 등)에서 안정적 주행
- 구동부는 일반적으로 **2륜 차동 주행(좌/우 독립 구동)**
- 등판 능력(5~10도) 고려
- 장시간 저속 운전 및 빈번한 정지/출발
- **저소음·고토크·저발열** 필요
- MCU(주로 STM32)와의 인터페이스 편의성

------

### **① 추천 구동 모터 타입: 24V 브러시리스 DC 모터(BLDC) + 감속기**

#### **왜 BLDC가 좋은가?**

- 지속 토크 우수
- 브러시 마모 없음 → 유지보수 감소
- 속도대비 소음 매우 낮음
- 효율 높고 발열 적어 배터리에도 유리
- FOC 드라이버 사용 시 부드러운 제어 가능
- 실외 진동·충격 환경 대응 우수

#### **모터 사양 예시**

- 24V, 150~350W
- 감속비 10:1~20:1
- 휠 토크 15~40 N·m
- 최대 속도 1~3 km/h 정도로 제한

------

### **② 주행 모터 드라이버 종류 비교**

#### **A. BLDC 전용 드라이버(FOC 기반 3상 인버터)** — *최적 선택*

- **장점**
  - 실시간 속도제어·토크제어 가능
  - 저속에서 진동 없이 부드럽게 주행
  - 전류/토크 제한 기능 우수 → 안전
  - 과열/과전류/저전압 보호 대부분 내장
- **대표 제품군**
  - TI DRV8305/8301 계열
  - ST STSPIN32G4 (MCU + 드라이버 통합)
  - ODrive(고출력, 자율주행 로봇용)
  - RoboteQ FBL series (산업용)

#### **B. 브러시드 DC 모터 드라이버(H-브릿지)** — *저가형 대안*

- **장점**: 회로구성 간단, 비용 낮음
- **단점**: 소음/발열/수명 짧음
- **예시**: BTS7960, VNH7040
- **적합성**: 극저가 또는 시제품

#### **C. PMSM 인버터 + 엔코더 기반 산업용 드라이브**

- **장점**: 산업 로봇 급 안정성
- **단점**: 가격 매우 비쌈
- **적합성**: 정식 인증 제품, 대량 생산 대비

------

### **③ 권장 드라이버 구조: BLDC FOC 듀얼 모터 드라이버**

#### **왜 듀얼 모터 드라이버인가?**

- 차동구동 로봇 특성상 좌/우 모터를 항상 함께 관리해야 함
- 2개의 드라이버를 따로 쓰면
  - 속도 편차 증가
  - 회전 반응성 저하
  - 동기화 어려움
- 듀얼 FOC 드라이버는
  - 두 모터의 RPM / 전류를 동기제어
  - 직진 안정성 향상
  - 회전 명령(Line/Angular Velocity) 구현 편리

#### **추천 구조 예시**

- **STSPIN32G4 × 2개 → 모터 2개 제어**
- **RoboteQ FBL2360 → 산업용 2채널 BLDC 드라이버**
- **ODrive S1(48V) → 고성능 BLDC 주행 제어**

------

### **④ 필수 보호 기능(안전 요건)**

- **전류 제한(Current Limit)**
  - 장애물 또는 경사면에서 stall 방지
- **차동 쇼크 보정(Differential Correction)**
  - 바퀴 미끄러짐 또는 바닥 요철 대응
- **과열 보호(OTP)**
- **배터리 저전압 보호(UVLO)**
- **비상 정지(E-stop) 우선 차단 기능**
- **전자 브레이크(Electric Brake) 기능**
  - 정지 시 슬립 방지
  - 탱크가 가득 찼을 때 무게 증가 대응

------

### **⑤ MCU와 드라이버 간 인터페이스**

- **PWM 입력 모드**
  - 좌/우 속도 직접 제어
  - 구현 간단하나 정밀도 제한
- **CAN 통신 모드(권장)**
  - RoboteQ, ODrive, ST 기반 드라이버 대부분 지원
  - 속도 명령, 토크 피드백, fault 정보 실시간 전송
  - 전기적 노이즈 강하며 선 길이 자유도 증가
- **UART 모드**
  - 디버깅 및 저속 제어에 유용
  - 주행 응답성에서는 CAN보다 떨어짐

------

### **⑥ 주행 안정성 알고리즘(컨트롤 로직)**

- **저속 시작(Smooth ramp-up)**
  - 폐유 가득 때 무게가 커 → 모터 보호
- **장애물 감지 시 감속**
  - 전류 스파이크 감지 → 자동 감속
- **곡선 주행 PID 제어**
  - 좌/우 휠 RPM 피드백 사용
- **경사 보정(tilt compensation)**
  - IMU 센서 기반 → 등판 시 출력 증가
- **중량 변화에 따른 토크 보정**
  - 탱크 레벨 기반 출력 자동 증가

------

### **⑦ 드라이버 설치 및 방열·방수 설계**

- 알루미늄 방열판 + 강제 공랭 또는 자연 냉각
- 전기함 내부 IP65 실링
- MOSFET/IGBT 발열을 냉장고 섀시 하부로 배출
- EMI 필터 + 코일 노이즈 필터링

## 7.4 레벨 센서, 압력 센서, 온도 센서

### **① 적용 가능 센서 종류**

폐식용유 수거 로봇에서 주로 다루게 될 매질이 “고점도·온도 변화·기름막 존재” 특성이 있으므로, 센서 선택 시 내오염성·온도 영향·유지보수 편의성을 모두 고려해야 합니다.

#### **● 레벨(Level) 센서**

- **초음파 레벨 센서**
  - 장점: 비접촉식, 탱크 내부 오염 영향을 적게 받음
  - 단점: 기름 표면의 난반사, 거품 발생 시 오차 증가
  - 인터페이스: 24V 산업용(PNP/NPN) 또는 RS485(Modbus), 소형은 5V PWM/Trig-Echo
- **부력식(플로트 스위치)**
  - 장점: 단순·저가·확실한 동작
  - 단점: 오염 시 움직임 방해, 배출/청소 시 구조적 배려 필요
  - 인터페이스: 단순 스위치 ON/OFF
- **차압식 레벨 센서(고정밀)**
  - 장점: 탱크 수위와 무관하게 유체 높이를 정밀 측정
  - 단점: 고점도 유체라 막힘 우려 → **격막(다이어프램) 타입 권장**
  - 인터페이스: 4–20 mA, 0–10 V, CAN, RS485

------

#### **● 압력(Pressure) 센서**

- **격막식 압력 센서(Diaphragm)**
  - 폐식용유 배관에서 필수 (막힘 방지)
  - 펌프 흡입/토출 압력 모니터링에 사용
  - 인터페이스:
    - 4–20mA → 장거리/노이즈 강함
    - 0–5V/0–10V → 단거리/아날로그 ADC
    - RS485 → 시리얼 통신 가능, 가장 안정적
- **기어펌프 토출 압력 확인용**
  - 최대 압력: 2~6 bar 정도 되는 센서 추천
  - 온도 영향 적게 받는 산업용 등급 권장

------

#### **● 온도(Temperature) 센서**

폐식용유의 점도는 온도에 매우 민감하므로 일정 온도(예: 30~40°C) 유지가 필요할 수 있음.

- **NTC/PT100/PT1000 온도센서**
  - PT100/1000 → 정확도 매우 높음, 배관/탱크 벽면 삽입 가능
  - NTC → 저가, MCU에 바로 연결 가능하지만 비선형
- **디지털 온도 센서**
  - DS18B20 (내열 튜브형) → 폐식용유 탱크 내부 온도 측정에 자주 사용
  - 인터페이스: 1-Wire

------

### **② 센서 인터페이스 회로 설계**

#### **1) 아날로그 센서(0–5 V / 0–10 V) → MCU**

- 0–10V → **분압회로 + 버퍼 op-amp**로 0–3.3V 변환
- 노이즈 많은 환경 → **RC 로우패스 필터 추가**
- MCU: STM32 ADC(12~16bit) 추천

------

#### **2) 4–20mA 산업용 센서 → MCU**

가장 표준적이며 신뢰성 높음.

#### **회로 구성**

- 4–20mA → 165Ω 정밀 저항 → ADC에서 0.66~3.3V로 읽기 가능
   예:
  - 4mA × 165Ω = **0.66V**
  - 20mA × 165Ω = **3.3V**
- 장점:
  - 긴 배선에서도 정확한 신호
  - 노이즈에 매우 강함
  - 산업용 센서 대부분 지원

------

#### **3) 디지털 센서(USART / RS485 / I2C / CAN)**

- **RS485 센서가 가장 현실적**
  - 장거리/노이즈에 매우 강함
  - 센서들을 Daisy-chain으로 연결 가능
  - 프로토콜: Modbus RTU가 일반적
- **I2C는 비추천**
  - 배관/모터/펌프 등 노이즈 심한 환경에서는 불안정

------

### **③ 센서 설치 포인트 설계**

#### **● 레벨 센서 위치**

- 초음파 → 탱크 맨 윗부분의 중앙부
- 부력식 → 탱크 측면(필요한 레벨에 맞춰 복수 배치)
- 차압식 → 탱크 밑면 or 사이드 포트

#### **● 압력 센서 위치**

- 펌프 **토출부 After-pump**
- 펌프 **흡입부 Before-pump**
- 필터 전/후 압력차 확인(PF ΔP 모니터링)

#### **● 온도 센서 위치**

- 탱크 내부 벽면 or 바닥 근처
- 폐식용유 예열기 사용 시 입구/출구 2지점 측정

------

### **④ MCU와 센서 연결 요약**

| 센서 종류 | 신호 타입         | 추천 MCU 포트 | 이유             |
| --------- | ----------------- | ------------- | ---------------- |
| 초음파    | PWM / UART        | GPIO/USART    | 단순, 비접촉     |
| 플로트    | On/Off            | GPIO          | 스위치 감지      |
| 차압식    | 4–20mA            | ADC           | 고정밀 수위 가능 |
| 압력 센서 | 4–20mA 또는 RS485 | ADC 또는 UART | 산업 표준        |
| 온도 센서 | 1-Wire / PT100    | GPIO/ADC      | 점도 제어용      |

## 7.5 유입량 계측·부하 감지 센서

폐식용유 수거 로봇에서 “유입량(flow-in)”과 “부하(load)”는
 ① **흡입 라인에 유체가 실제로 들어오는지**,
 ② **필터 막힘/펌프 부하 증가 여부**,
 ③ **탱크 유입량 실량 계산**,
 ④ **과부하·과압 자동 보호**
 를 위해 중요합니다.

------

### **① 유입량(FLOW) 계측에 사용되는 센서 종류**

### **1) 유량 센서(Flow Sensor) – 폐식용유 전용 구조 필요**

폐식용유는 점도가 높기 때문에 일반적인 플로우 센서는 사용이 어렵습니다.
 산업 현장에서는 다음 3가지 방식이 현실적입니다.

#### **● 기어형 유량 센서(Positive Displacement Gear Flow Meter)**

(★ 폐식용유·점성 유체에 가장 적합)

- 내부의 두 개의 기어가 회전 → 펄스 출력
- 점성 유체에서 정확성이 높음
- 주로 24V PNP/NPN 펄스 또는 RS485(Modbus) 방식
- 장점: 온도 영향 적음, 점도 높은 매질에 최적
- 단점: 가격이 있음, 이물질에 취약

#### **● 로터리 베인형(Rotary Vane) 유량계**

- 중점도 ~ 고점도까지 사용 가능
- 토크 증가량으로 유량 추정
- 장점: 큰 입자 포함된 유체에 일부 대응
- 단점: 정밀도는 기어형보다 떨어짐

#### **● 차압식 간접 유량 측정**

- 펌프 흡입/토출 압력 차이(ΔP) → 유량 간접 추정
- 장점: 센서 부착이 쉬움
- 단점: 정확한 유량 값은 어렵고, “막힘/부하” 감지용으로 적합

------

### **② 부하(Load) 감지 방식**

유입이 되지 않거나, 배관이 막히거나, 점도 상승으로 펌프에 부하가 걸릴 때 이를 감지해야 함.

### **1) 전류 센서(Current Sensor) – 펌프 부하 감지**

펌프가 막히면 **소비 전류가 증가**함.
 따라서 펌프 전류만 모니터링해도 막힘 감지가 가능.

#### 추천 센서

- **ACS712 / ACS758 / MLX91220**
- 산업용 전류 트랜스포머(CT)
- 샌드위치형 홀 센서(고정밀)

#### 감지 방식

- 정상 전류: 0.5~1A
- 막힘/점도 상승: 2~3A
   → MCU에서 threshold 비교로 “막힘 알람”

------

#### **2) 토크/로드셀 기반 부하 감지**

펌프 축에 직접 설치하면 정밀 부하 측정 가능하지만
 **구조 복잡·비용 높음 → 비추천**
 (산업식 오일 이송에서는 거의 사용하지 않음)

------

#### **3) 압력 기반 부하 감지**

펌프 토출 압력 상승(예: 0.8 bar → 1.8 bar)이
 배관 막힘 또는 오일 점도 증가를 의미.

→ **압력 센서 + ΔP 알고리즘**으로 막힘 조기 감지 가능.

------

### **③ 센서 신호 타입 및 MCU 인터페이스**

#### **● 기어형 유량 센서**

- **펄스 출력(PNP/NPN 24V)**
   → 옵토커플러 + 디바운스 → MCU GPIO
- RS485(Modbus RTU)
   → 전송 안정성 최고, 산업용 최고 등급

#### **● 전류 센서**

- 아날로그 센서(ACS758) → ADC
- 디지털 전류계 → I2C/UART
- 산업용 CT → burden resistor + ADC

#### **● 압력 센서**

- 4–20mA → 정밀 저항 변환 후 ADC
- RS485 → 산업 현장 최강 조합

------

### **④ 기계적 설치 포인트**

#### **1) 유량 센서 설치**

- 펌프 “토출 직후” 직관부에 설치
- 상·하류에 최소 5D 직관 확보(가능하다면)
- 기어형은 반드시 **수평 방향** 설치
- 역류 방지 밸브 이후 설치

#### **2) 전류 센서**

- 펌프 전원선(DC/AC)에 홀 센서 클램프
- 노이즈 방지를 위해 전원부와 떨어진 장소에 배치

#### **3) 압력 센서**

- 펌프 토출부
- 필터 앞/뒤 ΔP 측정
- 온도 영향으로 offset 발생하므로 보정 필요

------

### **⑤ 유입량 및 부하 감지 알고리즘**

#### **1) 유입량(Flow) 계산**

기어형 센서 기준:

```
Flow_rate (L/min) = (Pulse_per_sec × K_factor)
유입량 누적 = Σ Flow_rate × Δt
```

- MCU 타이머 인터럽트 활용
- K-factor: 센서 제조사가 제공 (예: 0.01 L/pulse)

------

### **2) 부하 감지(Load Detection)**

펌프 전류 + 압력센서 + 유량센서를 조합

#### **막힘 감지 조건**

- 전류 증가 ΔI > 30%
- 압력 증가 ΔP > 0.5 bar
- 유량 감소 < 정상의 60%
- 일정 시간 T > 0.5 sec 유지

→ 자동 정지 + 경고 출력

------

### **3) 흡입 실패 감지(Empty Suction / Dry Run)**

- 유량 0 L/min
- 압력 거의 없음 (0 bar)
- 전류 급감

→ 펌프 보호를 위한 자동 차단

------

### **⑥ MCU에 적용 시 최종 결론**

#### **유입량 센서**

- **1순위: 기어형 유량 센서 RS485 타입**
- 2순위: 기어형 PNP 펄스 출력 + MCU GPIO

#### **부하 감지**

- **펌프 토출 압력 센서(4–20mA)**
- **펌프 전류 센서(ACS758/CT)**
   둘 조합이 산업현장에서 가장 안정적입니다.

## 7.6 긴급 정지 시스템

### **① 긴급 정지(E-Stop) 기능 개요**

- 전체 시스템(컨베이어, 펌프, 주행 모터, 히터 등)을 즉시 안전한 상태로 전환
- 기계적 충돌·과부하·누유·전기적 이상 등 발생 시 즉각 차단
- IEC 60204-1 / ISO 13850 긴급정지 요구사항 준용
- 수동 버튼(E-Stop) + 자동 감지 소프트웨어 정지 모두 포함

------

### **② 긴급 정지 우선 순위 정의**

긴급 정지 시 전원 차단 우선순위(안전-critical 우선):

1. **주행 모터 드라이브(ESC/BLDC 인버터)**
2. **컨베이어 모터**
3. **펌프/밸브 계통**
4. **히터, 온도 조절부**
5. **MCU는 동작 유지(로그 저장 및 복구용)**

------

### **③ 긴급 정지 입력 장치 구성**

#### **1) 물리적 E-Stop Button (비상버튼)**

- 버섯형, 일체형 latching 타입
- 기계식 강제개폐(NC 접점)
- 프레임 전면 또는 상단에 1개
- 좌측/우측 서비스용 보조 E-Stop 1~2개 옵션

#### **2) 리셋 버튼**

- E-Stop 해제 후 재가동 시 필요한 별도 리셋 스위치
- 실수로 자동 재동작 방지 (ISO 13850 요구)

------

### **④ 자동 긴급 정지 트리거 조건**

#### **1) 전기적 트리거**

- 모터 드라이버 과전류(> 정격 120%)
- 배터리 과전압/저전압
- MOSFET 온도 과열(> 85°C)
- 펌프 드라이버 과전류

#### **2) 기계적/유압 트리거**

- 펌프 토출압 급상승(막힘)
- 탱크 레벨 센서 오버플로 임계치 도달
- 컨베이어 토크 증가(이물질 걸림)
- 차체 기울기 센서(예: > 15°) – 전도 방지

#### **3) 환경·운영 트리거**

- 외함 열센서(50–60°C 이상)
- 배관 온도/히터 이상 상승
- 연기 감지(optional)

#### **4) 사용자 소프트웨어 트리거**

- UI/컨트롤러에서 “긴급 정지” 메뉴 선택
- 무선 리모컨 E-Stop(옵션)

------

### **⑤ 긴급 정지 시 즉각 수행되는 동작**

1. **주행 모터 PWM 즉시 0 (하드웨어 차단)**
2. **컨베이어 모터 전원 릴레이 차단**
3. **펌프 전원/릴레이 차단 (역류·과압 방지)**
4. **히터 SSR·릴레이 차단**
5. **밸브는 스프링 리턴으로 닫힘(default closed)**
6. **MCU는 전원 유지하며 에러 로그 기록**
7. **경고등/부저 활성화**
8. **운영자 UI에 원인 메시지 표시**

------

### **⑥ 배선/회로 아키텍처**

#### **1) E-Stop Loop (하드웨어 차단 회로)**

- 전체 안전-critical 라인을 한 루프로 구성
- NC(정상 시 닫힘) → 절단 시 전체 릴레이 차단
- 모터/펌프/히터 라인 기준
- MCU는 단지 모니터링 역할만 담당(차단은 하드웨어가 담당)

#### **2) Safety Relay 또는 Power Cutoff Relay**

- 24V/48V DC 메인 버스를 직접 차단
- Fail-safe 설계
- 릴레이 코일은 E-Stop 루프에 연결 → E-Stop 눌리면 즉시 오프

#### **3) MCU 독립 전원 공급**

- 긴급정지 이후에도 MCU는 기록 및 UI 유지
- 배터리 BMS 출력 중 “논리 전원” 라인 별도 확보
- Hard-stop 영역과 Soft-stop 영역 분리

------

### **⑦ 긴급 정지 해제 및 복구 절차**

1. **이상 원인 해결**
   - 막힘, 과온, 과전류 등 확인
2. **E-Stop 버튼 해제 (회전하거나 당겨서 해제)**
3. **리셋 버튼 누름**
   - 릴레이/드라이버 초기화
4. **MCU 시스템 점검 시작**
   - 센서 self-test
   - 전류·압력 정상 범위 확인
5. **정상 운전 가능 상태 확정 후에만 재동작**

------

### **⑧ 진단 및 로그 기록 기능**

#### MCU는 긴급 정지 시 다음 정보를 저장:

- 트리거 센서 ID
- 당시 전류/압력/온도
- 모터 RPM상태
- 배터리 전압
- 펌프 유량
- 타임스탬프

→ 유지보수 및 오작동 분석에 매우 유용

------

### **⑨ 통신 연계**

- RS485/Modbus 또는 CAN으로 상태 보고
- PC/태블릿 UI에서 긴급 정지 원인 확인
- 원격 리셋 기능(안전 규제 상 차단할 수도 있음)

------

### **⑩ 기계적 설치 포인트**

- 프레임 상단 또는 전면에 크게 노출
- 작업자가 이동 중에도 쉽게 누를 수 있는 위치
- 방진·방수(IP65 이상)
- 내부 배선은 shield 케이블 사용
- 진동이 많은 모듈 근처는 기계식 보호 가이드 설치

## 7.7 원격 모니터링(BLE/Wi-Fi/LTE)

### **① 원격 모니터링 기능 개요**

- 기기의 **현재 상태/경고/센서값**을 실시간으로 외부 장치(스마트폰·PC·서버)에 전송
- 운영자(매장 직원/수거기사)가 **근거리(BLE)** 또는 **사업장 내부(Wi-Fi)**, **광역(LTE)** 범위에서 장치를 확인·제어
- 펌프 고장, 막힘, 누유, 오버플로 등의 위험을 현장에서 벗어나 있어도 즉시 알림
- 데이터 로그 자동 업로드 → 수거량/운영시간 관리

------

### **② 통신 모듈 옵션 비교**

#### **1) BLE (Bluetooth Low Energy)**

- 주로 스마트폰 근거리(3~10m) 모니터링
- 실시간 확인, 초기 설정, 펌웨어 업데이트 등에 사용
- 장점: 저전력, 앱 연동 용이
- 단점: 거리 짧음, 건물 내 장애물 영향 큼

#### **2) Wi-Fi**

- 매장 내부 공유기와 연결 → 내부망/클라우드 업로드
- 로컬 대시보드 운영 가능
- 장점: 속도 빠름, 데이터 용량 제한 적음
- 단점: 매장 Wi-Fi 세팅 필요

#### **3) LTE (Cat-M1 / NB-IoT / 일반 4G)**

- 전국 어디서나 상태 조회·통보 가능
- 수거 스케줄 관리 자동화
- 장점: 광역 통신, 관리 서버 연동 최적
- 단점: 모듈 가격 + 유심 비용 발생

------

### **③ 네트워크 아키텍처 구성**

#### **1) 내부 MCU → 통신 모듈 데이터 전달**

- UART / SPI / I2C 중 UART 사용 권장 (가장 안정적)
- 데이터 프레임 예시:

```
<HEADER>
TS=1738292      // timestamp
FLOW=1.23       // L/min
LEVEL=78        // %
TEMP=46.2       // °C
PRESS=0.48      // bar
ERR=0           // fault code
</END>
```

#### **2) 통신별 데이터 전달 구조**

- **BLE:** GATT 서비스 구조
  - Service: 0x180A (Device Info) + Custom Service
  - Characteristic: 센서값/명령용 UUID
- **Wi-Fi:**
  - MQTT over TLS
  - HTTP/REST API (장비가 서버로 POST)
- **LTE:**
  - MQTT(S)
  - LwM2M
  - FTP 로그 업로드(선택)

------

### **④ 원격 모니터링 데이터 항목**

#### **1) 실시간 센서 데이터**

- 탱크 레벨 (%)
- 유량(L/min), 유입량 누적(L)
- 펌프 압력(ΔP)
- 온도(탱크·히터·배관)
- 컨베이어 토크/전류
- 주행 배터리 잔량(%)
- 충전 상태(SOC/전류/전압)

#### **2) 상태/이상 정보**

- 막힘 감지
- 오버플로 감지
- 과압/과열
- 펌프 공회전(dry-run)
- E-Stop 활성화 여부
- 모터/드라이버 과전류

#### **3) 동작 기록(Log)**

- 하루 수거량(L)
- 컨베이어 가동 시간
- 펌프 동작 시간
- 주행 거리(옵션)
- 유지보수 타이머

------

### **⑤ 서버·클라우드 연동 기능**

#### **1) 클라우드 플랫폼 선택 옵션**

- AWS IoT Core
- Azure IoT
- Firebase
- 자체 MQTT 브로커(모스키토 등)

#### **2) 업로드 방식**

- 간격 데이터(주기: 1~10 sec)
- 이벤트 기반 데이터(E-Stop, 과압 등)
- 배치 로그 업로드(1시간마다)

------

### **⑥ 보안(Security) 설계**

#### **1) BLE 보안**

- BLE pairing + encryption
- 인증된 스마트폰만 접근 가능
- 관리용 PIN/토큰 적용

#### **2) Wi-Fi 보안**

- WPA2/WPA3
- HTTPS/TLS 암호화
- 인증 토큰(JSON Web Token) 사용

#### **3) LTE 보안**

- SIM 인증(기본)
- MQTT over TLS 적용
- 장비 고유 Device Key 저장(secure flash)

------

### **⑦ 원격 제어 기능(안전 제한 포함)**

#### **허용되는 원격 제어(안전 장치 통과 후만)**

- 컨베이어 ON/OFF
- 펌프 ON/OFF
- 히터 설정 온도 변경
- 주행 모터 제한 속도 설정
- 로그 다운로드
- 펌웨어 업데이트(OTA)

#### **금지되는 명령(안전 규정상)**

- 원격 E-Stop 비활성화
- 원격 주행 완전 제어(충돌 위험)
- 오버라이드로 히터 강제 On

------

### **⑧ 펌웨어/앱 UI 기능 요소**

#### **1) BLE 스마트폰 앱**

- 실시간 센서 모니터링
- 초기 세팅(Wi-Fi SSID/PW, LTE APN 설정 등)
- 펌웨어 업데이트(OTA)
- 진단 메시지 표시

#### **2) 웹 대시보드(Wi-Fi/LTE 연동)**

- 오늘/일간 수거량 그래프
- 기기 위치(GPS 탑재 시)
- 이벤트 로그
- 유지보수 알람
- 장비 리스트 관리 (다수 운영용)

------

### **⑨ 기계 외형·배치 고려**

- BLE 안테나는 금속 하우징 내부 실드는 피함
- Wi-Fi/LTE는 상단부 플라스틱 영역에 내장 안테나 설치
- 진동 및 기름/수분 환경 대비 IP65 케이블 글랜드 사용
- EMI/ESD 필터 포함

------

### **⑩ 전원 관리**

- 통신 모듈의 소비전력:
  - BLE: 20~40mA
  - Wi-Fi: 120~300mA
  - LTE: TX 시 1A~2A 순간 요구

→ 장비 내부 메인 배터리와 별도 **5V/3.3V DC-DC 안정화 회로** 필요

------

### **⑪ 원격 진단/유지보수**

- 장비 스스로 헬스체크 결과를 서버로 전송
- “필터 교체 필요”
- “배관 막힘 임박(ΔP 증가)”
- “탱크 청소 필요”
- “히터 효율 저하”
- OTA 업데이트로 기능 추가/버그 패치

## 7.8 UI 표시(OLED/LCD/터치패널)

사용자 인터페이스(UI) 표시 장치는 유지보수 편의성, 현장 운용성, 방진·방수 환경 등을 고려해 선택해야 한다.
 설비 상태, 경고 정보, 센서 값, 네트워크 상태, 모터 부하 등을 직관적으로 확인하는 것이 목적이다.

------

### **1) 디스플레이 종류별 특징 비교**

#### **① OLED (모노/컬러)**

- 장점
  - 전력 소모 적음
  - 높은 명암비(야간·실내용으로 가독성 우수)
  - 회로 단순, I²C/SPI로 바로 연결
- 단점
  - 강한 햇빛 아래 가독성이 나쁨
  - 산업용 외부 환경(고온·자외선)에 오래 노출 시 번인(Burn-in) 위험
- 추천 적용
  - 실내용 시스템
  - 배터리 기반 장비
  - 간단한 텍스트·아이콘 표시

#### **② LCD (문자 LCD, 그래픽 LCD, TFT-LCD)**

- 장점
  - 햇빛 아래도 비교적 가독성 좋음
  - 산업용 장비에서 표준처럼 사용
  - 비용이 낮고 수명이 길다
- 단점
  - 시야각 좁은 모델도 존재
  - 백라이트 필요 → 전력소모 증가
- 추천 적용
  - 실외 장비
  - 센서 값·상태 표시 중심의 시스템
  - 유지보수용 패널

#### **③ 터치패널(HMI 패널)**

- 종류: Resistive(저항막), Capacitive(정전용량)
- 장점
  - UI 직관적
  - 메뉴/로그/그래프 표시 가능
  - PLC/STM32/ESP32와 RS-485(Modbus), UART, Ethernet 등으로 쉽게 연동
- 단점
  - 가격 높음
  - 방수·방진 설계 필요(IP65~67급 옵션 가능)
- 추천 적용
  - 산업용 전면 패널
  - 관리자용 장비
  - 공장 자동화 및 데이터 로깅 목적

------

### **2) MCU 인터페이스 구성**

#### **① I²C (OLED/LCD 16x2/20x4 백패커)**

- 단순한 UI에 적합
- 2선(bus)으로 센서와 공유 가능
- 노이즈에 약해 30cm 이상은 권장 X → Shielded 케이블 필요

#### **② SPI (고속 TFT-LCD / OLED)**

- 빠른 화면 갱신 필요 시 사용
- 케이블 길이 짧아야 안정적

#### **③ UART/RS-485 (HMI 패널)**

- 산업용에서 가장 안정적
- **Modbus RTU** 프로토콜 사용 가능
- 10m~100m 이상 거리도 문제 없음
- PLC 또는 별도 MCU 없이 바로 통신 가능

#### **④ USB/HDMI (고급 UI)**

- Raspberry Pi + 7" 터치 같은 고급 UI 구성 시 사용
- 유지보수 난이도 및 비용 증가

------

### **3) 표시해야 하는 정보 항목**

#### **상태 정보**

- 모터 ON/OFF 상태
- 컨베이어 속도
- 배터리 또는 전원 상태

#### **센서 값**

- 레벨 센서 수위
- 압력 센서 값
- 온도
- 유량·부하량

#### **경고/에러 알림**

- 과압/저압
- 과부하
- 누유 감지
- 긴급 정지 활성화 여부

#### **통신 상태**

- Wi-Fi 연결 여부
- BLE 신호 세기
- LTE 모듈 연결 상태

#### **로그 / 유지보수 메뉴**

- 최근 에러 기록
- 펌웨어 버전
- 수동 제어 메뉴(모터 테스트 등)

------

### **4) UI 사용성(UX) 설계 포인트**

#### **① 현장에서 “한눈에” 보이도록**

- 숫자 표시 크게(16~32pt)
- 중요한 정보는 항상 상단 고정
- 경고 메시지는 반전·점멸 사용

#### **② 고장 시 접근 편리성**

- 정비 모드 별도
- 센서 값 RAW 데이터 확인 가능하게
- 버튼은 장갑 착용 환경 고려

#### **③ 환경적인 요소 고려**

- 실외 설치 시 → LCD 권장
- 높은 진동 환경 → 커넥터 고정용 브라켓 필요
- 고온 환경 → OLED 수명 짧아짐

------

### **5) 구성 예시(실제 설비 기준)**

#### **예시 A — ESP32 기반 소형 장비**

- 1.3" OLED (I²C)
- 표시: 속도, 수위, 배터리, Wi-Fi 상태
- 장점: 저전력, 회로 간단
- 단점: 햇빛 아래 가독성 낮음

#### **예시 B — STM32F4 + 3.5" TFT LCD**

- SPI 4-wire
- 표시: 센서 그래프, 장비 상태
- 장점: UI 커스터마이즈 용이
- 단점: 케이블 길이 제한

#### **예시 C — 산업용 HMI 터치패널**

- 통신: RS-485(Modbus RTU)
- 표시: 모터 제어 메뉴, 에러 로그
- 장점: 산업 현장에 최적화
- 단점: 비용 증가

## 7.9 배터리 BMS

BMS는 배터리 셀의 안전, 수명, 성능을 관리하기 위한 핵심 회로로서,
 산업용 장비·이동 플랫폼에서는 필수 안전 요소에 해당한다.
 특히 압력·유량·모터 부하가 존재하는 시스템에서는 **전원 안정성**이 장비 전반의 신뢰성과 직결된다.

------

### **1) BMS의 핵심 역할**

#### **① 충·방전 보호 (Protection)**

- 과전압(OVP): 셀 전압 허용치 이상 상승 시 충전 차단
- 저전압(UVP): 과방전 방지 위해 부하 차단
- 과전류(OCP): 모터·펌프 부하 급증 시 보호
- 단락 보호(SCP): 외부 단락·배선 문제 대응
- 온도 보호(OTP/UTP): 셀 과열 또는 극저온 충전 방지

#### **② 셀 밸런싱(Cell Balancing)**

- **수동 밸런싱(Passive)**
  - 저항으로 잉여 셀 전류를 열로 소모
  - 구조 단순, 저렴, 소형 장비 대부분 여기에 해당
- **능동 밸런싱(Active)**
  - 에너지 재배분 방식
  - 대용량 배터리/고가 장비/AGV/전기차 수준에서 사용

#### **③ SoC / SoH 계산**

- SoC(State of Charge): 남은 배터리 용량
- SoH(State of Health): 배터리 노화 상태
- MCU에 전달해 UI에 표시하거나 주행 성능 조절에 활용

#### **④ 배터리 데이터 로깅**

- 충전 횟수
- 최대/최저 셀전압
- 과전류 발생 이력
- 온도 상승 패턴
- 진단용 데이터 확보

------

### **2) 배터리 팩 구성 방식**

#### **① 1S (3.7V)**

- 소형 장비, 센서 모듈
- 보호회로만 쓰는 간단한 경우 많음

#### **② 다셀 직렬팩(2S~6S 등)**

- 7.4V / 11.1V / 14.8V / 22.2V 등
- 모터 구동 장비(컨베이어, 주행 모터 등)에 주로 사용
- 셀 밸런싱 필수

#### **③ 대용량(예: E-bike, AGV 등)**

- 10S~15S 이상
- RS-485/CAN 통신형 BMS + 히트싱크 + 정밀 온도센서 필요

------

### **3) BMS 하드웨어 구성**

#### **① 보호 IC(PMU)**

- TI: BQ29700 (1S), BQ76920/30/40(3S~15S)
- 중국계: DW01 + 8205A (1S), CF/JK 시리즈(5S~20S)

#### **② 전류 측정 샌스저항 (Shunt)**

- ±50A/100A 등급
- 저항값: 0.5mΩ ~ 5mΩ
- 모터 부하 변동 감지 가능

#### **③ 온도센서(NTC/PTC)**

- 1~3개 배치
- 셀 간 온도 편차 감지

#### **④ 밸런싱 회로**

- 수동: 저항 + MOSFET
- 능동: 인덕터/커패시터 기반

#### **⑤ 커넥터**

- 셀 밸런스 잭(예: JST-XH)
- CT/DT(CT: charge, DT: discharge) 구분 가능한 출력 구조

------

### **4) BMS와 메인 MCU의 인터페이스**

#### **① 단순 보호형 BMS**

- MCU와 독립적으로 동작
- 보호 기능이 발동되면 출력 전압이 급격히 떨어짐
- MCU는 “전원 끊김” 상태로 인식
- 장점: 단가 낮음
- 단점: 상태 모니터링 불가

#### **② 통신형 BMS**

- UART, I²C, CAN, RS-485
- 제공 정보
  - 각 셀 전압
  - 팩 전압
  - 충전/방전 전류
  - 온도
  - SoC/SoH
  - 알람 상태(OVP/UVP/OC, OTP 등)
- 장점: 산업용 장비에 필수
- 단점: 복잡도/단가 증가

**→ 공장 자동화, 주행형 장비는 “통신형 BMS”를 강력 추천.**

------

### **5) 관리 소프트웨어 구조**

#### **① 데이터 수집 Task (주기: 100~500ms)**

- 셀 전압 배열 읽기
- 팩 전압
- 전류값
- 온도
- SoC 계산

#### **② 이상 판단 로직**

- UVP/OVP/HV/OT 과도 상태 감지
- 경고 vs 차단 분리
  - Warning: UI 표시
  - Fault: 모터 드라이버 강제 OFF

#### **③ 로그 기록**

- EEPROM / FRAM / SD카드
- 전압·전류 히스토리
- 고장 발생 시점 저장

#### **④ UI 연계**

- 배터리 아이콘
- 남은 시간 추정(SoC 기반)
- 충전 중 애니메이션
- Fault 발생 시 팝업

------

### **6) 배터리 팩 안전 설계 요소**

#### **① 방열 설계**

- 셀 사이 *열 전달 패드*
- 하우징 내부 *알루미늄 열판*
- 온도 급상승 시 팬 구동 or 출력 제한

#### **② 배선 설계**

- 22~18 AWG 실리콘 와이어
- 셀 간 밸런스 리드선을 PCB에 확실히 고정
- 모터 구동선은 반드시 **배터리와 분리 배치**

#### **③ 퓨즈(Fuse) 또는 PTC**

- 단락/과전류 사고 대응
- 용량 2~10A 권장(장비 스펙에 따라 상이)

#### **④ 하우징**

- 난연재(ABS V0 등급) 권장
- IP54 이상 방진·방수
- 충격 완화 스펀지 추가

------

### **7) 시스템 구성 예시**

#### **예시 A — 소형 장비(2S 또는 3S)**

- 3S BMS(수동 밸런싱)
- STM32/ESP32와 독립 운용
- UI에서 팩 전압만 표시
- 목적: 단순 전원 공급

#### **예시 B — 주행형 장비(4S~6S)**

- 4~6S 통신형 BMS(UART 또는 CAN)
- 모터 드라이버와 연동
- SoC 기반 “잔여 주행 가능 시간” 표시
- 과부하 보호 적극 활용

#### **예시 C — 산업용 PLC 기반**

- BMS ↔ PLC(Modbus RTU/485)
- 팩 상태 SCADA에 연동
- Fault 발생 시 자동 정지 + 알람 출력

------

### **8) BMS 모델 추천(실제 산업에서 자주 사용)**

#### **국내·중국 상용 BMS**

- JBD / Daly / ANT BMS (4S~20S)
- 장점: 통신형, 설정 SW 제공, 가격 저렴
- 인터페이스: UART / RS-485 / CAN

#### **TI 기반 고성능 BMS**

- BQ769x 시리즈(3S~15S)
- C2000/STM32 연동 필수
- AGV/로봇 수준 고정밀 설비에 사용

#### **단일 셀 보호**

- DW01 + 8205A(보호회로)
- 1S 보조 전원에 적합